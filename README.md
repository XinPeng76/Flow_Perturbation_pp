# Flow_Perturbation
We introduce the flow perturbation method, which incorporates optimized stochastic perturbations into the flow. By reweighting trajectories generated by the perturbed flow, our method achieves
unbiased sampling of the Boltzmann distribution with orders of magnitude speedup compared to both brute force
Jacobian calculations and the Hutchinson estimator. 

![Flow Perturbation](./figures/ODE_pf.png "Title")

***
# Dependencies
* Mandatory
  * [pytorch>=2.0](https://github.com/pytorch/pytorch)
  * [numpy==1.26.4](https://github.com/numpy/numpy)
  * [easydict](https://pypi.org/project/easydict/)
  * [bgmol](https://github.com/noegroup/bgmol) (for  Chignolin)
  * [bgflow](https://github.com/noegroup/bgmol) (for  Chignolin)
  * [mdtraj==1.9.9](https://github.com/mdtraj/mdtraj) (for  Chignolin)

## Training
* All hyper-parameters and training details are provided in config files (), and free feel to tune these parameters../configs/*.yml
  
```bash
python train.py ./configs/GMM10D_default.yml ./models/GMM10D
python train.py ./configs/GMM1000D_default.yml ./models/GMM1000D
python train.py ./configs/CGN_default.yml ./models/CGN
```

* The model checkpoints will be saved in the specified directory,e.g., ./models/GMM10D

## Metropolis Monte Carlo (MC) simulations
* The Metropolis MC simulations are provided in the following files:

```bash
python MC.py ./configs/CGN_default.yml ./models/CGN --method 0 --M 1
python MC.py ./configs/GMM1000D_default.yml ./models/GMM1000D --method 0 --M 1
```

* The first argument specifies the configuration file, while the second argument indicates the model directory. The `--method` option determines the approach for running the Monte Carlo (MC) simulations:
 - `0`: Flow Perturbation (FP)
  - `-1`: Jacobian-based method
  - `-2`: Stochastic Normalizing Flow (SNF)
  - `1-n`: Hutchinson trace estimator
- `--eps_type` parameter: Defines the type of perturbation to use, such as Rademacher, Gaussian, etc.
-  `--M` 'Multiple Noises: Noise Vectors Generated by the FP Method.

## Sequential Monte Carlo (SMC)
* The Sequential Monte Carlo in the following files:
```bash
python SMC.py ./configs/GMM10D_default.yml ./models/GMM10D --method 0 --eps_type Rademacher --M 1
python SMC.py ./configs/GMM1000D_default.yml ./models/GMM1000D --method 0 --eps_type Rademacher --M 1
python SMC.py ./configs/CGN_default.yml ./models/CGN --method 0 --eps_type Rademacher --M 1
```
* The first argument specifies the configuration file, while the second argument indicates the model directory. The `--method` option determines the approach for running the Sequential Monte Carlo (SMC) simulations:
 - `0`: Flow Perturbation (FP)
  - `-1`: Jacobian-based method
  - `-2`: Stochastic Normalizing Flow (SNF)
  - `1-n`: Hutchinson trace estimator
- `--eps_type` parameter: Defines the type of perturbation to use, such as Rademacher, Gaussian, etc.
-  `--M` 'Multiple Noises: Noise Vectors Generated by the FP Method.


## Model and Data
* The result datasets presented in the paper can be found in the `Result` folder of this repository.


## [License](#dependencies)
[MIT License](LICENSE)
